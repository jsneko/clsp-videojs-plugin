<html>
   
   <script src="jquery.min.js"></script>
   <script src="mqttws31.js"></script>
   <script src="webcam.js"></script>

<script>
//polyfill
if (typeof Object.assign != 'function') {
  Object.assign = function(target, varArgs) { // .length of function is 2
    'use strict';
    if (target == null) { // TypeError if undefined or null
      throw new TypeError('Cannot convert undefined or null to object');
    }

    var to = Object(target);

    for (var index = 1; index < arguments.length; index++) {
      var nextSource = arguments[index];

      if (nextSource != null) { // Skip over if undefined or null
        for (var nextKey in nextSource) {
          // Avoid bugs when hasOwnProperty is shadowed
          if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {
            to[nextKey] = nextSource[nextKey];
          }
        }
      }
    }
    return to;
  };
}
</script>

   <script src="iov.js"></script>
  <script>

// create module, all default dettings


function main(){
   var self = this;
   IOV({
       address: "davidschere.online",
       appStart: function(iov) {
           // create a player for video.
           self.p = iov.player();
           iov.getAvailableStreams(function(resp){
               var streamNames = resp.names;
               var html = "";
               streamNames.forEach(function(n){
                   html += '<option value="'+n+'">';   
               });
               $('#streamNames').html(html); 
               $('#streamNames2').html(html); 
           });
           $('#play').click(function(){
               var elm = $('#names');
               var selected = elm.val();
               if ((typeof selected != 'undefined') && (selected.length > 0)) {
                   
                   self.p.play("v1",selected,function(){
                       console.log("v1 first chunk");
                   });
               }           
           });
           $('#stop').click(function(){
               self.p.stop();
           });


           $('#logvideo').change(function () {
               if ($(this).is(':checked')) {
                    self.p.LogSourceBuffer = true;
                    self.p.LogSourceBufferTopic = $('#logvideo_topic').val();
               } else {
                    self.p.LogSourceBuffer = false;
               }
           });


           // create a player for video.
           self.p2 = iov.player();
           $('#play2').click(function(){
               var elm = $('#names2');
               var selected = elm.val();
               if ((typeof selected != 'undefined') && (selected.length > 0)) {
                   self.p2.play("v2",selected,function(){
                       console.log("v2 first chunk");
                   });
               }           
           });
           $('#stop2').click(function(){
               self.p2.stop();
           });

           

       }
   });//end IOV








   self.timer = null;

   $('stop-live-stream').click(function(){		
       if (self.timer) {
           clearTimeout( self.timer );
	   self.timer = null;
       }
   });

   $('#start-live-stream').click(function(){
       if (self.timer)
           return; 

       Webcam.set({
           width: 320,
	   height: 240,
	   image_format: 'jpeg',
	   jpeg_quality: 90
       });
       Webcam.attach( '#broadcast_camera' );
       var n = $('#webcam-stream-name').val();
       var webcam_topic = "webcam/"+fake_guid(); 
       var msg = {
           resp_topic:"iov/webcam/response/"+fake_guid(),
           name: n,
           url: "mqtt://"+webcam_topic,
           onDemand: false
       };

       // send publish message
       var topic = "iov/video/publish";          
       var mqtt_msg = new Paho.MQTT.Message(JSON.stringify(msg));
       mqtt_msg.destinationName = topic;
       self.p.transport.subscribe(msg.resp_topic,function(x){
           console.log("response: " + JSON.stringify(x));
       });
       MQTTClient.send(mqtt_msg);

       function take_snapshot() {
           // take snapshot and get image data
	   Webcam.snap( function(data_uri) {
               var raw_image_data = data_uri.replace(/^data\:image\/\w+\;base64\,/, '');
	       var vd = Webcam.base64DecToArr(raw_image_data);

               var mqtt_msg = new Paho.MQTT.Message(vd);
               //mqtt_msg.payloadBytes = vd;
               mqtt_msg.destinationName = webcam_topic;
               MQTTClient.send(mqtt_msg);
           });
       }


       Webcam.on("live",function(){
           // set timer to periodically take snap shots.
           take_snapshot(); 
           self.timer = setInterval( take_snapshot, 1000 );
       }); 

       
       

   });  

   

}//end main 
  </script>       


<body onload="main()">
 <video id="v1"
   controls
   autoplay
   width="240"
   height="352"
 >
</video>

<h2>
 <video id="v2"
   controls
   autoplay
   width="240"
   height="352"
 >
</video>



<div>
  <input list="streamNames" name="streamName" id="names">
  <datalist id="streamNames">
  </datalist>
  <button id="play">Play</button>
  <button id="stop">Stop</button>
</div>


<div>
  <input list="streamNames2" name="streamName2" id="names2">
  <datalist id="streamNames2">
  </datalist>
  <button id="play2">Play</button>
  <button id="stop2">Stop</button>
</div>

<p>
  MQTT Log video topic: <input type="text" value="" id="logvideo_topic"><br>
  <input type="checkbox" id="logvideo"> 
</p>


<h3 id="latency"></h3>

<p>
   <h1>WebCam feed</h1><br>
   <div id="broadcast_camera"></div>
   <hr>
   <input type="text" id="webcam-stream-name">  
   <button id="start-live-stream">Start</button>	
   <button id="stop-live-stream">Stop</button>	
</p>	


</body>
</html>
